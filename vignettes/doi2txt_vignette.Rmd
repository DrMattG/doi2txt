---
title: "Using doi2txt to extract sections of full text articles"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using doi2txt to extract sections of full text articles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Ideas and notes

Is this the proper use of a vignette? No, but it seems like the easiest way to work together on getting the package built and tested since it is easy to leave notes and ideas here with examples.

## lapply and using lists

One idea I (Eliza) had is to make all the functions default to using lapply since we don't know how many items will be passed to any given function. This would put us solidly in the realm of lists as our primary way of working with data, which I think is technically not following tidy principles. It may be unavoidable though, since all of the text sections will be of variable length. We could collapse them into one large character block with manual line breaks though, if people think it would be best to return data.frames from functions. Thoughts?

## tidy?

Relatedly, how tidy do we want to be? Assuming this gets wrapped up in the metaverse, then I think we are supposed to aim for following tidy principles because of funding for that project. Martin, does it matter on your end?

## Dealing with odd errors

When working with scraped data, we will inevitably encounter lots of errors that we did not plan for and are not built into the functions to cope with. My suggestion for this, which is currently implemented in a couple functions, is to use try() to catch error messages, and then replace any resulting error messages with NA. Does anyone know of better approaches for this problem?


# "Clean" example that makes use of wrapper functions

This first section is the "clean" version of the first few steps in the package, meaning it uses the wrapper functions which is presumably what most users will want to do. The idea for this section is just to have some example DOIs, download the associated HTML journal articles, and extract the methods and references.

```{r}

library(doi2txt)

# Example DOIs used for function testing
# Should all be open access, if I recall correctly

#dois <- get_dastardly_dois(limit=100)
#dois <- dois[!is.na(dois)]

# results of running the above code; the function is random so now we have persistent dois
dois <- c("10.3204/pubdb-2018-01257", "10.1002/hpm.2581", "10.1093/isq/sqz012", 
"10.14358/pers.82.12.955", "10.5169/seals-129753", "10.1016/j.socscimed.2014.08.028", 
"10.1371/journal.pone.0182528", "10.14288/1.0185192", "10.11588/ger.1954.45177", 
"10.1021/acs.jctc.9b00741", "10.4067/s0716-97602005000400002", 
"10.1088/1361-6404/ab1a52", "10.22004/ag.econ.28524", "10.1016/j.bioelechem.2010.06.009", 
"10.15122/isbn.978-2-8124-3963-6.p.0595", "10.3390/app8112059", 
"10.1006/jasc.1998.0331", "10.1111/j.1365-2958.2006.05102.x", 
"10.13140/rg.2.2.16078.61764", "10.1016/j.wneu.2019.08.001", 
"10.1242/dev.086900", "10.1039/b314760f", "10.21980/j8j01x", 
"10.5281/zenodo.3819156", "10.17863/cam.48292", "10.1080/15374416.2019.1678167", 
"10.18634/sophiaj.13v.2i.571", "10.5281/zenodo.1316690", "10.5169/seals-449734", 
"10.3929/ethz-b-000227178", "10.1109/robot.2006.1642310", "10.1016/j.neuron.2010.08.002", 
"10.1016/j.jfma.2018.05.010", "10.1038/35084593", "10.1016/j.neuron.2008.01.019", 
"10.1007/s11071-019-04851-8", "10.1007/s10811-010-9590-y", "10.1159/000486772", 
"10.15463/rec.1189731477", "10.1111/joac.12271", "10.1248/cpb.50.935", 
"10.1063/1.3487748", "10.17192/ep1991.2.5451", "10.1016/j.tetlet.2018.03.061", 
"10.24411/2500-2872-2018-10015", "10.24411/2618-9674-2019-10008", 
"10.1080/00958972.2014.885508", "10.18540/revesvl2iss2pp0160-0174"
)

articles <- lapply(dois[1:3], doi2html)

methods <- lapply(articles, extract_section, section="methods")

references <- lapply(articles, extract_section, section="references")

abstracts <- lapply(articles, extract_section, section="introduction")

```

# Behind the scenes example

This section is intended for troubleshooting since it goes through all the subfunctions that are called above so we can see where things break down. If one line runs, then the next line should theoretically run since the subfunctions have been checked, but who knows what fun errors I have introduced.

```{r}
# just using article #1 here

# first, the guts of doi2html

url <- get_url(dois[1])

x <- htm2txt::gettxt(url)

class(x)=="character"

x <- split_lines(x)

 if (any(x == "")) {
    x <- x[-which(x == "")] # remove blank lines
 }

articles <- x


# now for extract_section

text <- articles
section="methods"
# I couldnt run this without adding in section = "methods" "Error in which(names(sections) == section) : object 'section' not found"

start <- find_section(section, text)

#start <- find_section("methods", text) # replaced methods with section

next_section <- names(sections)[(which(names(doi2txt::sections) == section) + 1)]

if (next_section %in% names(sections)) {
      end <- find_section(next_section, text) - 1
    } else{
      end <- length(text)
    }
    
text[start:end]

```

# Problems

This is a graveyard for problems that need to be solved or complexities of downloading some articles. For example, html pages that cannot be rendered properly, hitting a sign-in screen, the actual article being an embedded pdf on an html site, needing to click through a link to get to the actual article, etc. Please be as specific as possible with problems, and preferably include an example of where doi2txt fails in regards to a particular problem with code to reproduce it. 

## Subscription issue

The third doi (10.1016/j.cja.2014.04.019) leads to a paywalled HTML. The full text HTML is there, but I'm accessing it through a proxy. Can someone with a VPN or onsite license try?

```{r}

#placeholder for problem 1 code example

```

## No HTML available

The fourth doi (10.24843/EJA.2019.v26.i01.p07) leads to an abstract but no HTML full text, just a PDF. It's for a rather obscure Indonesian language journal, so low priority.

## Mini-sections in the abstract

Some articles use section headers in the abstract, so there are two section headers detected for methods and it retrieves the first one instead of the actual methods section. May need to change how we process length and/or check the nchar of the line immediately following each detected header.

This is now fixed with commit 1ff4cba.

```{r}
doi <- "10.1002/hpm.2581"

article <- doi2html(doi)

methods <- extract_section(article, "methods")

```

